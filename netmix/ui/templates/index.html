<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Netmix Dashboard</title>
    <style>
        body { font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, "Helvetica Neue", Arial, sans-serif; background-color: #f4f4f9; color: #333; margin: 2em; }
        h1 { color: #444; }
        table { width: 100%; border-collapse: collapse; box-shadow: 0 2px 4px rgba(0,0,0,0.1); }
        th, td { padding: 12px 15px; text-align: left; border-bottom: 1px solid #ddd; }
        thead { background-color: #007bff; color: white; }
        tbody tr:nth-child(even) { background-color: #f9f9f9; }
        tbody tr:hover { background-color: #f1f1f1; }
        .status-GOOD { color: #28a745; font-weight: bold; }
        .status-DEGRADED { color: #ffc107; font-weight: bold; }
        .status-DOWN { color: #dc3545; font-weight: bold; }
    </style>
</head>
<body>
    <h1>Netmix Real-Time Dashboard</h1>
    <div id="zerotier-status">
        <h2>ZeroTier Status</h2>
        <p>Loading...</p>
    </div>

    <h2>Interface Health</h2>
    <table id="interfaces-table">
        <thead>
            <tr>
                <th>Interface</th>
                <th>Status</th>
                <th>Avg Latency (ms)</th>
                <th>Success Rate</th>
                <th>Failures</th>
                <th>Active Connections</th>
                <th>Downstream</th>
                <th>Upstream</th>
            </tr>
        </thead>
        <tbody id="interfaces-body">
            <!-- Data will be populated by JavaScript -->
        </tbody>
    </table>

    <script src="https://cdnjs.cloudflare.com/ajax/libs/socket.io/4.0.1/socket.io.js"></script>
    <script>
        document.addEventListener('DOMContentLoaded', (event) => {
            const socket = io.connect('http://' + document.domain + ':' + location.port + '/dashboard');

            function formatBytes(bytes, decimals = 2) {
                if (bytes === 0) return '0 Bytes';
                const k = 1024;
                const dm = decimals < 0 ? 0 : decimals;
                const sizes = ['Bytes', 'KB', 'MB', 'GB', 'TB'];
                const i = Math.floor(Math.log(bytes) / Math.log(k));
                return parseFloat((bytes / Math.pow(k, i)).toFixed(dm)) + ' ' + sizes[i];
            }

            socket.on('connect', () => {
                console.log('Connected to Netmix WebSocket!');
            });

            socket.on('update', (payload) => {
                console.log('Received update:', payload);

                // Update Interface Health Table
                const health_data = payload.health_data || {};
                const tbody = document.getElementById('interfaces-body');
                tbody.innerHTML = ''; // Clear existing rows

                for (const name in health_data) {
                    const stats = health_data[name];
                    const latencies = stats.latencies;
                    const avgLatency = latencies.length ? (latencies.reduce((a, b) => a + b, 0) / latencies.length).toFixed(2) : 'N/A';
                    const total = stats.successes + stats.failures;
                    const successRate = total > 0 ? ((stats.successes / total) * 100).toFixed(1) + '%' : '100%';
                    let status = 'DOWN';
                    if (avgLatency !== 'N/A' && parseFloat(avgLatency) < 100) status = 'GOOD';
                    else if (avgLatency !== 'N/A' && parseFloat(avgLatency) < 1000) status = 'DEGRADED';
                    const row = `<tr>
                        <td>${name}</td>
                        <td class="status-${status}">${status}</td>
                        <td>${avgLatency}</td>
                        <td>${successRate}</td>
                        <td>${stats.failures}</td>
                        <td>${stats.active_conns}</td>
                        <td>${formatBytes(stats.bytes_received)}</td>
                        <td>${formatBytes(stats.bytes_sent)}</td>
                    </tr>`;
                    tbody.innerHTML += row;
                }

                // Update ZeroTier Status
                const zt_data = payload.zerotier_data || {};
                const zt_div = document.getElementById('zerotier-status');

                if (zt_data.error) {
                    zt_div.innerHTML = `<h2>ZeroTier Status</h2><p>Error: ${zt_data.error}</p>`;
                } else if (zt_data.status && zt_data.managed_network) {
                    const node_status = zt_data.status.online ? 'ONLINE' : 'OFFLINE';
                    const net = zt_data.managed_network;
                    let details_html = `<h2>ZeroTier Status: <span class="status-${node_status === 'ONLINE' ? 'GOOD' : 'DOWN'}">${node_status}</span></h2>`;

                    if (net.error) {
                        details_html += `<p><strong>Managed Network:</strong> ${net.id}</p><p><strong>Status:</strong> <span class="status-DEGRADED">${net.status}</span> (${net.error})</p>`;
                    } else {
                        const ip = net.assignedAddresses ? (net.assignedAddresses.find(a => a.includes('.')) || 'N/A').split('/')[0] : 'N/A';
                        const status_class = net.status === 'OK' ? 'GOOD' : 'DEGRADED';
                        details_html += `
                            <p><strong>Managed Network:</strong> ${net.id} (${net.displayName || ''})</p>
                            <p><strong>Status:</strong> <span class="status-${status_class}">${net.status}</span></p>
                            <p><strong>Virtual IP:</strong> ${ip}</p>
                        `;
                    }
                    zt_div.innerHTML = details_html;
                } else if (zt_data.status) {
                    const node_status = zt_data.status.online ? 'ONLINE' : 'OFFLINE';
                    zt_div.innerHTML = `<h2>ZeroTier Status: <span class="status-${node_status === 'ONLINE' ? 'GOOD' : 'DOWN'}">${node_status}</span></h2><p>No managed network configured in .env file.</p>`;
                }
                else {
                    zt_div.innerHTML = '<h2>ZeroTier Status</h2><p>Could not retrieve status. Is the ZeroTier client running?</p>';
                }
            });
        });
    </script>
</body>
</html>
